<!--
    Azure API Management - Webhook Policy
    Applied to webhook endpoints (/api/v1/webhooks/*)
    Higher rate limits for Exotel webhook deliveries
-->
<policies>
    <inbound>
        <!-- No CORS for webhooks (Exotel server-to-server) -->

        <!-- Webhook Rate Limiting (Higher limits for Exotel) -->
        <rate-limit-by-key calls="10000"
                           renewal-period="60"
                           counter-key="@(context.Request.IpAddress)"
                           increment-condition="@(context.Response.StatusCode >= 200 && context.Response.StatusCode < 500)" />

        <!-- IP Whitelist for Exotel (Optional) -->
        <!-- Uncomment and add Exotel IP ranges if known -->
        <!--
        <ip-filter action="allow">
            <address>52.66.0.0/16</address>
            <address>13.126.0.0/16</address>
        </ip-filter>
        -->

        <!-- Log webhook request -->
        <set-variable name="webhookBody" value="@(context.Request.Body.As<string>(preserveContent: true))" />
        <set-variable name="webhookHeaders" value="@{
            var headers = new JObject();
            foreach (var header in context.Request.Headers)
            {
                headers.Add(header.Key, string.Join(",", header.Value));
            }
            return headers.ToString();
        }" />

        <!-- Validate webhook signature (if Exotel sends it) -->
        <!-- This will be validated in the backend as well -->

        <!-- Set timeout for webhook processing -->
        <set-backend-service base-url="https://banxway-api.ambitiousglacier-6604109c.centralindia.azurecontainerapps.io" />
        <timeout>60</timeout>

        <base />
    </inbound>
    <backend>
        <!-- Forward to backend -->
        <base />
    </backend>
    <outbound>
        <!-- Always return 200 for webhooks to prevent Exotel retries -->
        <choose>
            <when condition="@(context.Response.StatusCode >= 500)">
                <return-response>
                    <set-status code="200" reason="OK" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>{"success": false, "error": "Internal processing error, will retry"}</set-body>
                </return-response>
            </when>
        </choose>

        <base />
    </outbound>
    <on-error>
        <!-- Log webhook errors -->
        <trace source="webhook-error">
            @{
                return new JObject(
                    new JProperty("message", context.LastError.Message),
                    new JProperty("source", context.LastError.Source),
                    new JProperty("webhookBody", context.Variables["webhookBody"]),
                    new JProperty("webhookHeaders", context.Variables["webhookHeaders"])
                ).ToString();
            }
        </trace>

        <!-- Always return 200 to Exotel -->
        <return-response>
            <set-status code="200" reason="OK" />
            <set-header name="Content-Type" exists-action="override">
                <value>application/json</value>
            </set-header>
            <set-body>{"success": false, "error": "Processing error"}</set-body>
        </return-response>

        <base />
    </on-error>
</policies>
